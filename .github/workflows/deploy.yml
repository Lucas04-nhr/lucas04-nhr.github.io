name: Deploy VuePress Site to GitHub Pages

on:
  # å½“ push åˆ° main åˆ†æ”¯æ—¶è§¦å‘éƒ¨ç½²
  push:
    branches: [main]
  # æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
  workflow_dispatch:

# Use minimal read for contents and give Pages and id-token write permissions
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  check-version:
    name: Check template version
    runs-on: ubuntu-latest
    outputs:
      is-latest: ${{ steps.check.outputs.is-latest }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if template version is latest
        id: check
        run: |
          # ä½¿ç”¨ GITHUB_TOKEN é¿å… API é™é€Ÿ
          LATEST_VERSION=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/pengzhanbo/vuepress-theme-plume/releases/latest | jq -r .tag_name)

          # ç§»é™¤ v å‰ç¼€
          LATEST_VERSION_CLEAN="${LATEST_VERSION#v}"

          # è·å–å½“å‰ç‰ˆæœ¬
          CURRENT_VERSION=$(jq -r '.devDependencies["vuepress-theme-plume"]' package.json)

          echo "Latest version: $LATEST_VERSION_CLEAN"
          echo "Current version: $CURRENT_VERSION"

          if [ "$LATEST_VERSION_CLEAN" = "$CURRENT_VERSION" ]; then
            echo "is-latest=true" >> $GITHUB_OUTPUT
            echo "âœ… Template version is up to date"
          else
            echo "is-latest=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Template version is outdated: $CURRENT_VERSION (latest: $LATEST_VERSION_CLEAN)"
            echo "Please wait for the update_dependencies workflow to update the template"
          fi

      - name: Trigger update workflow
        if: steps.check.outputs.is-latest == 'false'
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/update_dependencies.yml/dispatches \
            -d '{"ref":"main"}'
          echo "ğŸ”„ Triggered update_dependencies workflow"
          exit 1

  build:
    name: Build site and upload pages artifact
    runs-on: ubuntu-latest
    needs: check-version
    if: needs.check-version.outputs.is-latest == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          # ä¿ç•™å…¨éƒ¨æäº¤å†å²ä»¥ä¾¿ç”Ÿæˆâ€œæœ€è¿‘æ›´æ–°æ—¶é—´â€ç­‰ä¿¡æ¯
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build VuePress site
        env:
          NODE_OPTIONS: --max_old_space_size=8192
        run: pnpm run docs:build

      - name: Configure Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v4
        with:
          # VuePress é»˜è®¤è¾“å‡ºç›®å½•
          path: docs/.vuepress/dist

  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
