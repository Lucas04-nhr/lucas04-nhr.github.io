name: Update Dependencies

on:
  workflow_dispatch:
  schedule:
    - cron: "0 20 * * 0" # 每周一 4:00(CST) 运行一次

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.24.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for updates
        id: check_updates
        run: |
          # 使用 GITHUB_TOKEN 避免 API 限速
          LATEST_VERSION=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/pengzhanbo/vuepress-theme-plume/releases/latest | jq -r .tag_name)

          # 移除 v 前缀用于比较
          LATEST_VERSION_CLEAN="${LATEST_VERSION#v}"

          # 获取当前版本
          CURRENT_VERSION=$(jq -r '.devDependencies["vuepress-theme-plume"]' package.json)

          echo "Latest version: $LATEST_VERSION (clean: $LATEST_VERSION_CLEAN)"
          echo "Current version: $CURRENT_VERSION"

          # 比较版本是否需要更新
          if [ "$LATEST_VERSION_CLEAN" != "$CURRENT_VERSION" ] && [ "$LATEST_VERSION_CLEAN" != "null" ] && [ "$LATEST_VERSION_CLEAN" != "" ]; then
            echo "NEEDS_UPDATE=true" >> $GITHUB_ENV
            echo "NEW_VERSION=$LATEST_VERSION_CLEAN" >> $GITHUB_ENV
            echo "Update needed: $CURRENT_VERSION -> $LATEST_VERSION_CLEAN"
          else
            echo "NEEDS_UPDATE=false" >> $GITHUB_ENV
            echo "Already up to date"
          fi

      - name: Update dependencies
        if: env.NEEDS_UPDATE == 'true'
        run: |
          pnpm dlx vp-update

      - name: Commit changes
        if: env.NEEDS_UPDATE == 'true'
        run: |
          git config --local user.email 'github-actions[bot]@users.noreply.github.com'
          git config --local user.name 'github-actions[bot]'
          git add package.json pnpm-lock.yaml
          git commit -m "chore(dep): Update template to ${{ env.NEW_VERSION }}"
          git push
